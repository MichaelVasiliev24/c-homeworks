name: Build and Lint

on:
  push:
  pull_request:

jobs:
  format-check:
    name: Check code formatting
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install clang-format
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format-18
      
      - name: Check formatting
        run: |
          echo "Checking code formatting..."
          
          # Ищем C файлы
          C_FILES=$(find . -path ./build -prune -o -type f \( -name "*.c" -o -name "*.h" \) -print 2>/dev/null || true)
          
          if [ -z "$C_FILES" ]; then
            echo "No C files found. Skipping formatting check."
            exit 0
          fi
          
          echo "Found $(echo "$C_FILES" | wc -l) files to check"
          
          # Проверяем форматирование только если есть .clang-format
          if [ -f .clang-format ]; then
            echo "$C_FILES" | xargs -r clang-format-18 --style=file --dry-run -Werror
            echo "All files are properly formatted"
          else
            echo "No .clang-format file found, skipping format check"
          fi
  
  build-and-test:
    name: Build and test
    runs-on: ubuntu-latest
    needs: format-check
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            clang-tidy-18 \
            cmake \
            build-essential
      
      - name: Check if CMakeLists.txt exists
        id: check-cmake
        run: |
          if [ -f "CMakeLists.txt" ]; then
            echo "CMakeLists.txt exists, proceeding with CMake build"
            echo "CMAKE_EXISTS=true" >> $GITHUB_OUTPUT
          else
            echo "CMakeLists.txt not found"
            echo "CMAKE_EXISTS=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Check if there are source files
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true'
        id: check-sources
        run: |
          echo "Checking for source files..."
          
          # Проверяем есть ли C файлы
          C_FILES=$(find . -name "*.c" ! -path "./build/*" 2>/dev/null | head -5 || true)
          
          if [ -z "$C_FILES" ]; then
            echo "No C source files found"
            echo "HAVE_SOURCES=false" >> $GITHUB_OUTPUT
          else
            echo "Found $(echo "$C_FILES" | wc -l) source files"
            echo "HAVE_SOURCES=true" >> $GITHUB_OUTPUT
          fi
      
      - name: CMake build (only if CMakeLists.txt exists AND there are source files)
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true' && steps.check-sources.outputs.HAVE_SOURCES == 'true'
        run: |
          echo "Building with CMake..."
          mkdir -p build
          cd build
          
          cmake .. \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON \
            -DCMAKE_BUILD_TYPE=Debug \
            -DBUILD_TESTING=ON \
            -DCMAKE_C_FLAGS="-Wall -Wextra"
          
          echo "CMake configuration complete"
      
      - name: Build targets
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true' && steps.check-sources.outputs.HAVE_SOURCES == 'true'
        run: |
          cd build
          
          if cmake --build . --parallel $(nproc); then
            echo "Build successful"
            
            EXEC_COUNT=$(find . -type f -executable ! -path "*/CMakeFiles/*" 2>/dev/null | wc -l || true)
            echo "Built $EXEC_COUNT executables"
            
            if [ "$EXEC_COUNT" -gt 0 ]; then
              echo "HAVE_EXECUTABLES=true" >> $GITHUB_ENV
            else
              echo "HAVE_EXECUTABLES=false" >> $GITHUB_ENV
            fi
          else
            echo "Build failed"
            exit 1
          fi
      
      - name: Run tests with CTest
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true' && steps.check-sources.outputs.HAVE_SOURCES == 'true' && env.HAVE_EXECUTABLES == 'true'
        run: |
          cd build
          
          echo "Running tests..."
          
          if ctest -N 2>&1 | grep -q "Test #"; then
            TEST_COUNT=$(ctest -N 2>&1 | grep "Test #" | wc -l)
            echo "Found $TEST_COUNT CTest test(s)"
            echo "Running tests..."
            
            if ctest --output-on-failure; then
              echo "All tests passed"
            else
              echo "Some tests failed"
              exit 1
            fi
          else
            echo "No CTest test targets configured"
            
            echo "Checking executables for tests..."
            ALL_EXECS=$(find . -type f -executable ! -path "*/CMakeFiles/*" 2>/dev/null || true)
            
            TEST_FOUND=false
            for exec_path in $ALL_EXECS; do
              exec_name=$(basename "$exec_path")
              
              # Пробуем запустить с --test
              if timeout 3s ./"$exec_path" --test >/dev/null 2>&1; then
                echo "Running $exec_name with --test flag..."
                if ./"$exec_path" --test; then
                  echo "$exec_name tests passed"
                  TEST_FOUND=true
                fi
              fi
            done
            
            if [ "$TEST_FOUND" = false ]; then
              echo "No tests found in executables"
            fi
          fi
      
      - name: Run clang-tidy
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true' && steps.check-sources.outputs.HAVE_SOURCES == 'true'
        run: |
          if [ -f "build/compile_commands.json" ]; then
            echo "Running clang-tidy..."
            
            find src -name "*.c" 2>/dev/null | head -3 | \
              while read -r file; do
                if [ -f "$file" ]; then
                  echo "Analyzing $file..."
                  clang-tidy-18 "$file" -p=build --checks='clang-analyzer-*' --quiet 2>&1 | \
                    grep -E "(error|warning|note):" || true
                fi
              done
            echo "Clang-tidy check completed"
          else
            echo "compile_commands.json not found - skipping clang-tidy"
          fi
      
      - name: Skip build (no CMakeLists.txt)
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'false'
        run: |
          echo "Skipping build - no CMakeLists.txt found"
          exit 0
      
      - name: Skip build (no source files)
        if: steps.check-cmake.outputs.CMAKE_EXISTS == 'true' && steps.check-sources.outputs.HAVE_SOURCES == 'false'
        run: |
          echo "Skipping build - CMakeLists.txt exists but no source files"
          exit 0
      
      - name: Final status
        run: |
          echo "=== CI Pipeline Summary ==="
          echo "Format check: PASSED"
          echo "CMakeLists.txt: ${{ steps.check-cmake.outputs.CMAKE_EXISTS || 'false' }}"
          echo "Source files: ${{ steps.check-sources.outputs.HAVE_SOURCES || 'false' }}"
          echo "==========================="
